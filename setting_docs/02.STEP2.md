# 02. Azure Portal 연동

## 1. 사전 준비
1. 리소스 그룹 생성
2. Azure OpenAI 리소스 생성
  - Azure AI Foundry 생성
    - Chat 모델 : gpt-4.1-mini
    - Embedding 모델 : text-embedding-3-small
3. Azure AI Search 리소스 생성
  - 가격 책정 계층 : 기본
4. `.env` 파일에 Key, Endpoint 설정
5. Azure Storage 생성
  - 개발자 가이드 업로드(검색 후 PDF로 출처 링크 시 사용) 

## 2. 데이터 업로드
  - 실제 Embedding 및 검색에 사용될 규격서 업로드
    - Azure Storage 생성
    - Azure AI Search에서 데이터 가져오기(new) -> RAG 선택
    - index에 source와 path 추가(파일명, 파일 위치)
    - 스킬셋에 source와 path 추가
    - 인덱스 재실행

## 3. 소스 개발
  - 폴더/파일 구성
  ```
  .
  ├── pyproject.toml
  ├── .env
  ├── README.md
  ├── docs/                 # 개발 가이드 PDF 위치
  └── src/
      ├── app/
      │   ├── main.py       # Flask API 
      │   ├── config.py     # 환경변수 Load
      │   ├── rag_chain.py  # 컨텍스트→LLM 호출
      │   ├── retriever.py  # Azure hybrid Search
      │   ├── prompts/      # 프롬프트 구성 - 필요시 변경
      │   │   └── system_ko.md 
      │   └── indexing/     # 지금은 Azure Portal에서 진행했지만 나중에 필요에 따라 코드화
      └── ui/
          └── streamlit_app.py  # UI구성(추후 UI는 조금 더 세련된 UI로 변경)
  ```

## 4. .gitignore 추가
  - `.env,` `.venv`를 gitignore에 추가하여 github에 업로드가 되지 않도록 하자.(이건 github에서 프로젝트 생성시 gitignore를 추가하면 자동으로 생성됨.)

## 5. API & UI 실행(Local) - 추후 Azure Portal로 웹앱 배포
  ```
  python -m src.app.main                 # http://localhost:8000
  streamlit run src/ui/streamlit_app.py  # http://localhost:8501
  ```

## 6. 웹앱 배포
  - Azure Portal에서 App Services를 선택, App Service를 생성한다.
  - 런타임 스펙은 Python 3.11
  - 지역은 나머지 리소스들과 동일한 지역으로 선택
  - 플랜은 기본(B1)
  - 배포 탭에서 지속적인 배포 설정을 사용으로 전환한다.
    - GitHub를 선택한다(내 계정으로 로그인하여 프로젝트 및 브런치를 선택)
    - 소스 코드를 Github push 간 새로 빌드하여 서비스들에서 즉각 반영됨.
  1. API 배포
    - 위 조건에 방법대로 앱을 배포한 후 아래 설정을 구성한다.
    - 설정 - 환경변수에서 `.env`에 있는 각종 환경변수들을 추가한다.
    - 설정 - 구성 - 시작명령 : `gunicorn -w 2 -k gthread -t 120 -b 0.0.0.0:8000 src.app.main:app`
    - 설정이 완료되면 앱을 재시작한다.

  2. UI 배포
    - API와 마찬가지로 앱을 배포한 후 아래 설정을 구성한다.
    - 설정 - 환경변수에서 `.env`에 있는 API_URL을 위 API의 기본도메인으로 설정한다.(`https://{API 기본 도메인}/ask`)
    - 설정 - 구성 - 시작명령 : `streamlit run src/ui/streamlit_app.py --server.port 8000 --server.address 0.0.0.0`
    - 설정이 완료되면 앱을 재시작한다.